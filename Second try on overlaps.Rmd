---
title: "Variant_Overlap_2"
author: "Christis Nicolaides"
date: "2025-06-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
if("librarian" %in% installed.packages()==FALSE) install.packages("librarian")
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.20")
librarian::shelf(tidyverse, purrr, BiocManager, AnnotationDbi, 
                 qvalue, GO.db, org.Hs.eg.db, reshape2, UniProt.ws, biomaRt, GenomicRanges, rtracklayer)
```

```{r}
#Load data
cad_bed <- read.table(".\\data\\raw\\hglft_genome_31753d_markername.bed", header = FALSE, stringsAsFactors = FALSE)

colnames(cad_bed) <- c("chr", "start", "end", "markername")

pqtl <- as.data.frame(read.csv(".\\data\\raw\\pQTL_discovery.csv"))
pqtl$CHROM <- paste0("chr", pqtl$CHROM)

```

create genomic ranges data
```{r}
gr_cad <- GRanges(
    seqnames = cad_bed$chr,
    ranges   = IRanges(start = cad_bed$start,
                       end   = cad_bed$end),
    CAD_marker = cad_bed$markername
)

print(gr_cad)

#expand grcad by +/-100kbp
gr_cad_100k <- gr_cad
start(gr_cad_100k) <- pmax(1, start(gr_cad) - 100000)
end(gr_cad_100k) <- end(gr_cad) +100000

#also make a +/-1k
gr_cad_1k <- gr_cad
start(gr_cad_1k) <- pmax(1, start(gr_cad) - 1000)
end(gr_cad_1k) <- end(gr_cad) +1000

#pqtl genomic ranges
pqtl$position <- pqtl$GENPOS..hg38.
pqtl$markername <- pqtl$Variant.ID..CHROM.GENPOS..hg37..A0.A1.imp.v1.

gr_pqtl <-  GRanges(
    seqnames = pqtl$CHROM,
    ranges   = IRanges(start = pqtl$position,
                       end   = pqtl$position),
    pQTL_marker = pqtl[["markername"]]
)



```

find overlaps
500k
```{r}
hits_500k <- findOverlaps(gr_cad, gr_pqtl,
                           maxgap = 500000)

#create dataframe

overlap_500k <- as_tibble(data.frame(
    CAD_index  = queryHits(hits_500k),
    pQTL_index = subjectHits(hits_500k)
)) %>%
  mutate(
    CAD_marker = mcols(gr_cad)$CAD_marker[CAD_index],
    pQTL_marker = mcols(gr_pqtl)$pQTL_marker[pQTL_index]
  ) %>%
  dplyr::select(CAD_marker, pQTL_marker)

#uplaod to onedrive
saveRDS(
  overlap_500k,
  file = "./data\\processed\\overlap_500k.RDS"
)

write.csv(
  overlap_500k,
  file = "./data\\processed\\overlap_500k.csv",
  row.names = FALSE
)

```


```{r}
#100k
hits_100k <- findOverlaps(gr_cad_100k, gr_pqtl)

#create dataframe
overlap_100k <- as_tibble(data.frame(
    CAD_index  = queryHits(hits_100k),
    pQTL_index = subjectHits(hits_100k)
)) %>%
  mutate(
    CAD_marker = mcols(gr_cad)$CAD_marker[CAD_index],
    pQTL_marker = mcols(gr_pqtl)$pQTL_marker[pQTL_index]
  ) %>%
  dplyr::select(CAD_marker, pQTL_marker)

saveRDS(
  overlap_100k,
  file = "./data\\processed\\overlap_100k.RDS"
)

write.csv(
  overlap_100k,
  file = "./data\\processed\\overlap_100k.csv",
  row.names = FALSE
)

#1k
hits_1k <- findOverlaps(gr_cad_1k, gr_pqtl) 

#create dataframe
overlap_1k <- as_tibble(data.frame(
    CAD_index  = queryHits(hits_1k),
    pQTL_index = subjectHits(hits_1k)
)) %>%
  mutate(
    CAD_marker = mcols(gr_cad)$CAD_marker[CAD_index],
    pQTL_marker = mcols(gr_pqtl)$pQTL_marker[pQTL_index]
  ) %>%
  dplyr::select(CAD_marker, pQTL_marker)

saveRDS(
  overlap_1k,
  file = "./data\\processed\\overlap_1k.RDS"
)

write.csv(
  overlap_1k,
  file = "./data\\processed\\overlap_1k.csv",
  row.names = FALSE
)
```

map your variants to the nearest gene located (Bioinformatics.annotated gene) and affected protein and the gene fo that proteib (Assay.Target and Target.UniProt) 

```{r}
pqtl_annotation <- pqtl %>%
  dplyr::select(markername,
         Assay.Target,
         Target.UniProt,
         Bioinfomatic.annotated.gene, log10.p...discovery.)%>%
  dplyr::rename(pQTL_marker = markername)

#try 1bp 

annotated_overlap_500k <- merge(overlap_500k,
                                         pqtl_annotation,
                                         by = "pQTL_marker",
                                         all.x = TRUE)


annotated_overlap_100k <- merge(overlap_100k,
                                         pqtl_annotation,
                                         by = "pQTL_marker",
                                         all.x = TRUE)

annotated_overlap_1k <- merge(overlap_1k,
                                         pqtl_annotation,
                                         by = "pQTL_marker",
                                         all.x = TRUE)


#print annotated 100 and 500


saveRDS(
  annotated_overlap_100k,
  file = "./data\\processed\\annotated_overlap_100k.RDS"
)

write.csv(
  annotated_overlap_100k,
  file = "./data\\processed\\annotated_overlap_100k.csv",
  row.names = FALSE
)

saveRDS(
  annotated_overlap_500k,
  file = "./data\\processed\\annotated_overlap_500k.RDS"
)

write.csv(
  annotated_overlap_500k,
  file = "./data\\processed\\annotated_overlap_500k.csv",
  row.names = FALSE
)

saveRDS(
  annotated_overlap_1k,
  file = "./data\\processed\\annotated_overlap_1k.RDS"
)

write.csv(
  annotated_overlap_1k,
  file = "./data\\processed\\annotated_overlap_1k.csv",
  row.names = FALSE
)

```

```{r}
data_filt_glyenz <- read.csv("./data\\processed\\data_filt_glyenz.csv")
data_gly <-read.csv("./data\\processed\\data_gly_final.csv")
data_lectin <- read.csv("./data\\processed\\data_glylect.csv")

#check overlap on annotated gene with enzyme data

overlap_gene_500k <- unique(annotated_overlap_500k$Bioinfomatic.annotated.gene)

overlap_gene_100k <- unique(annotated_overlap_100k$Bioinfomatic.annotated.gene)


common_overlap_enz_500k <- intersect(overlap_gene_500k, data_filt_glyenz$enz_gene)

common_overlap_enz_100k <- intersect(overlap_gene_100k, data_filt_glyenz$enz_gene)

#check overlap of assay target with targets in enzyme 

overlap_target_500k <- unique(annotated_overlap_500k$Assay.Target)

overlap_target_100k <- unique(annotated_overlap_100k$Assay.Target)



common_overlap_target_500k <- intersect(overlap_target_500k, data_filt_glyenz$Gene_name)

common_overlap_target_100k <- intersect(overlap_target_100k, data_filt_glyenz$Gene_name)


overlap_100k

#overlap with glycosylation in general?


print(common_overlap_enz_100k)

common_targets_list <- list()

genes <- c("ST3GAL4","DPAGT1", "GALNT4", "B3GNT3", "B3GNT8", "FUT9", "ST3GAL5", "B4GALNT2")

 for (gene in genes) {
  gene_targets <- data_filt_glyenz %>%
    filter(enz_gene == gene) %>%
    distinct(Gene_name)
  
  ppp_gene_target <- pqtl %>%
    filter(cis.trans == "trans") %>%
    filter(Bioinfomatic.annotated.gene == gene)%>%
    distinct(Assay.Target)
  
common_targets <- intersect(
  intersect(gene_targets$Gene_name, common_overlap_target_100k),
  ppp_gene_target$Assay.Target
)  
  #prioritise the ones targeted witht he specific gene. 
  
  common_targets_list[[gene]] <- common_targets
 }

# To view the results:
print(common_targets_list)

common_targets_nonspecific_list <- list()

genes_nonspecific <- c("ST3GAL4","DPAGT1", "GALNT4", "B3GNT3", "B3GNT8", "FUT9", "ST3GAL5", "B4GALNT2")

 for (gene in genes_nonspecific) {
  ppp_gene_target_nonspecific <- pqtl %>%
    filter(cis.trans == "trans") %>%
    filter(Bioinfomatic.annotated.gene == gene)%>%
    distinct(Assay.Target)
  
common_targets_nonspecific <-
  intersect(ppp_gene_target_nonspecific$Assay.Target, data_filt_glyenz$Gene_name)
  #prioritise the ones targeted witht he specific gene. 
  
  common_targets_nonspecific_list[[gene]] <- common_targets_nonspecific
 }

print(common_targets_nonspecific_list)

print(common_overlap_enz_100k)

common_targets_lectin_list <- list()


genes_lectin <- c("ST3GAL4","DPAGT1", "GALNT4", "B3GNT3", "B3GNT8")
for (gene in genes_lectin) {
  gene_targets_lectin <- data_lectin %>%
    filter(Lectin_Gene_name == gene) %>%
    distinct(Gene_name)
  
  ppp_lectin_target <- pqtl %>%
    filter(cis.trans == "trans") %>%
    filter(Bioinfomatic.annotated.gene == gene)%>%
    distinct(Assay.Target)
  
common_targets_lectin <- intersect(
  intersect(gene_targets_lectin$Gene_name, common_overlap_target_100k),
  ppp_lectin_target$Assay.Target)

common_targets_lectin_list[[gene]] <- common_targets_lectin

}

print()

print(common_targets_lectin_list)
```
