---
title: "24_coloc"
output: html_document
date: "2025-03-20"
editor_options: 
  chunk_output_type: console
---

```{r}
if("librarian" %in% installed.packages()==FALSE) install.packages("librarian")
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.20")
librarian::shelf(tidyverse, data.table, BiocManager, coloc, 
                 rtracklayer, stringr, parallel)

library(tidyverse)
```

#try
#"ANKLE2_Q86XL3_S528"
#JCAD_Q9P266_S901

#read in sum stats CAD region of interest
```{r}
#EDIT THIS PATH TO MATCH YOUR INPUT. DON'T worry about hard coding right now. You can always come back and automate
cad_for_coloc <- read.table(".\\data\\raw\\coloc_enz_genes\\ST3GAL4_for_coloc.txt", header = TRUE, sep = "", stringsAsFactors = FALSE, fill = TRUE)



#rename to plink columnnames
metal_to_plink_formatter <- function(sum_stats){
 # colnames(sum_stats) <- gsub("P-value", "P", colnames(sum_stats))
  colnames(sum_stats) <- gsub("MarkerName", "SNP", colnames(sum_stats))
  colnames(sum_stats) <- gsub("Effect", "BETA", colnames(sum_stats))
  sum_stats$SNP <- gsub(":", "_", sum_stats$SNP, fixed = T)
  return(sum_stats)
}

cad_for_coloc_formatted <- metal_to_plink_formatter(cad_for_coloc)
colnames(cad_for_coloc_formatted) <- gsub("Freq1", "MAF", colnames(cad_for_coloc_formatted))

lead_snp <- cad_for_coloc_formatted[which.min(cad_for_coloc_formatted$P),] #note the p-val is probably bigger than the data you have been looking at because these are the euro not meta-analysis sum stats

#how was the lead_SNP decided here? the one with the lowest p value is that how is hould also do it or should I do the UKB-PPP SNP?



```


#read in PROTEIN sum stats and filter
```{r}
protein_for_coloc <- as.data.frame(read.table(".\\data\\raw\\coloc_enz_genes\\PRSS27_UKBPPP.txt", header = TRUE, sep = "", stringsAsFactors = FALSE, fill = TRUE))

head(protein_for_coloc)
dim(protein_for_coloc)

#Make sure the UKB protein data has columns called SNP, BETA, MAF, N, SE
#renaming columns
protein_for_coloc <- protein_for_coloc %>%
  dplyr::rename(
    SNP     = variant,
    CHR     = chr,
    BP      = pos,
    P       = p,
    StdErr  = se,
    Allele1 = effect_allele,
    Allele2 = other_allele,
    N       = n,
    BETA    = beta,
    MAF     = eaf
  )

```

```{r}
#replace indels with D|I
process_snp <- function(snp) {
  parts <- strsplit(snp, "_")[[1]]
  if (length(parts) != 4) return(snp)  # Skip malformed SNPs
  
  ref <- parts[3]
  alt <- parts[4]
  
  if (nchar(ref) > 1 | nchar(alt) > 1) {
    # Indel detected
    if (nchar(ref) > nchar(alt)) {
      ref <- "D"
      alt <- "I"
    } else {
      ref <- "I"
      alt <- "D"
    }
  }
  
  # Recombine into the same format
  return(paste(parts[1], parts[2], ref, alt, sep = "_"))
}

cad_for_coloc_formatted$SNP <- sapply(cad_for_coloc_formatted$SNP, process_snp)
protein_for_coloc$SNP <- sapply(protein_for_coloc$SNP, process_snp)

```



#need the same snps in the same order. Will need to invert beta and maf if flipped
```{r}
align_ASCII_sort <- function(data, effect_allele, other_allele, beta = "BETA", maf = "MAF") {
  A1 <- data[[effect_allele]]
  A2 <- data[[other_allele]]
  sorted <- t(apply(cbind(A1, A2), 1, sort))
  flip <- A1 != sorted[,1]
  data[[beta]][flip] <- -data[[beta]][flip]
  data[[maf]][flip] <- 1 - data[[maf]][flip]
  data[[effect_allele]] <- sorted[,1]
  data[[other_allele]] <- sorted[,2]
  data$flipped_ascii_sort <- flip
  return(data)
}

cad_for_coloc_formatted$BETA <- as.numeric(cad_for_coloc_formatted$BETA)
protein_for_coloc$BETA <- as.numeric(protein_for_coloc$BETA)


#####
create_SNPid <- function(dataset, chr, pos, other_allele, effect_allele) {

    # Construct SNP ID: chr_pos_A1_A2
    SNPid <- paste(dataset[[chr]], dataset[[pos]], dataset[[effect_allele]], dataset[[other_allele]], sep = "_")

    return(SNPid)
}
#####

#UP TO HERE YOU NEED TO GET MAFS SOMEHOW: UKB COULD DO ????

cad_for_coloc_sorted <- align_ASCII_sort(data = cad_for_coloc_formatted, effect_allele = "Allele1", other_allele = "Allele2", beta = "BETA", maf = "MAF") #had to delete SNPid
cad_for_coloc_sorted$MAF_ascii <- cad_for_coloc_sorted$MAF
cad_for_coloc_sorted$ascii_snpid <- create_SNPid(cad_for_coloc_sorted, "CHR", "BP", "Allele2", "Allele1")

protein_for_coloc_sorted$Allele1 <- tolower(protein_for_coloc_sorted$Allele1)
protein_for_coloc_sorted$Allele2 <- tolower(protein_for_coloc_sorted$Allele2)

protein_for_coloc_sorted <- align_ASCII_sort(data = protein_for_coloc, effect_allele = "Allele1", other_allele = "Allele2", beta = "BETA", maf = "MAF") #had to delete SNPid
protein_for_coloc_sorted$MAF_ascii <- protein_for_coloc_sorted$MAF
protein_for_coloc_sorted$ascii_snpid <- create_SNPid(protein_for_coloc_sorted, "CHR", "BP", "Allele2", "Allele1")



```

#filter for only common snps
```{r}

#prot data
#need to convert uppercase to lowercase for protein_for_coloc_sorted


cad_for_coloc_common <- cad_for_coloc_sorted[which(cad_for_coloc_sorted$ascii_snpid %in% protein_for_coloc_sorted$ascii_snpid),]

dim(cad_for_coloc_common) #4698
cad_for_coloc_common <- cad_for_coloc_common[order(cad_for_coloc_common$ascii_snpid),]

#trait data
prot_data_common <- protein_for_coloc_sorted[which(protein_for_coloc_sorted$ascii_snpid %in% cad_for_coloc_common$ascii_snpid),]
prot_data_common <- prot_data_common[order(prot_data_common$ascii_snpid),]



#IMPORTANT THIS SAYS TRUE
all(cad_for_coloc_common$ascii_snpid == prot_data_common$ascii_snpid) #TRUE

cad_for_coloc_common$varbeta <- (cad_for_coloc_common$StdErr)^2
prot_data_common$varbeta <-(prot_data_common$StdErr)^2
```

#format CAD and protien sum stats for coloc
```{r}

cad_for_coloc_common <- cad_for_coloc_common %>%
  distinct(SNP, .keep_all = TRUE)

cad_input_list <- list(
  snp = cad_for_coloc_common$SNP,
  beta = cad_for_coloc_common$BETA,
  varbeta = cad_for_coloc_common$varbeta,
  MAF = cad_for_coloc_common$MAF,
  N = cad_for_coloc_common$N,
  type = "cc" #case control
)

prot_data_common <- prot_data_common %>%
  distinct(SNP, .keep_all = TRUE)

protein_input_list <- list(
  snp = prot_data_common$SNP,
  beta = prot_data_common$BETA,
  varbeta = prot_data_common$varbeta,
  sdY = 1, #because the protein values are already normalised 
  MAF = prot_data_common$MAF,
  N = prot_data_common$N , 
  type = "quant"
)

coloc_results <- coloc.abf(cad_input_list, protein_input_list)

print(coloc_results)

saveRDS(coloc_results, file = "coloc_results_ST3GAL4_ PRSS27.rds")

```

